# Tacview 30架以上飞机数据发送修复

## 问题描述

**症状**：当飞机数量超过30架时，Tacview 接收不到数据或数据显示异常。

**根本原因**：
1. **数据格式错误**：每架飞机都单独发送时间戳帧头 `#时间戳`，导致数据格式混乱
2. **时序问题**：Tacview协议要求同一时间帧的所有对象数据应该在一个时间戳下发送
3. **数据量大**：30架飞机 × 错误的格式 = 数据包过大或格式解析失败

## 修复方案

### 1. 数据格式重构

**修改前（错误）**：
```
#123.45
3000001,T=...  # 飞机1
#123.45
3000002,T=...  # 飞机2
#123.45
3000003,T=...  # 飞机3（每个飞机都带时间戳）
```

**修改后（正确）**：
```
#123.45        # 时间帧头（只发送一次）
3000001,T=...  # 飞机1
3000002,T=...  # 飞机2
3000003,T=...  # 飞机3
...            # 所有飞机
```

### 2. 代码修改

#### 修改 1：`send_drone_data()` 方法
- **从**：直接发送数据到socket
- **改为**：返回格式化的数据行（不包含时间戳）

#### 修改 2：新增 `send_frame_data()` 方法
- 批量发送整帧数据
- 自动处理大数据包（超过64KB时分批）
- 支持 50+ 架甚至上百架飞机

#### 修改 3：推演循环优化
- 收集所有飞机数据
- 一次性批量发送
- 减少网络开销

### 3. 性能优化

✅ **数据分批**：超过64KB自动分批（每批50架飞机）
✅ **错误处理**：添加详细的错误日志和异常追踪
✅ **状态统计**：显示飞机数量和发送状态

## 测试验证

### 测试场景
1. **小规模**（10-20架）：验证基本功能正常
2. **中规模**（30-50架）：验证原问题已修复
3. **大规模**（50+架）：验证分批发送机制

### 测试步骤
1. 启动应用程序
2. 添加30架以上红方飞机
3. 生成态势文件
4. 启动 Tacview（连接到 127.0.0.1:58008）
5. 开始推演
6. 观察 Tacview 中的飞机显示

### 预期结果
- ✅ Tacview 正常连接
- ✅ 所有飞机正常显示
- ✅ 飞行轨迹流畅
- ✅ 红蓝双方颜色正确
- ✅ 控制台无错误信息

## 技术细节

### Tacview ACMI 数据格式
```
FileType=text/acmi/tacview
FileVersion=2.2
0,ReferenceTime=2025-11-08T00:00:00Z

#0.00                           ← 时间帧标记
3000001,T=lon|lat|alt|...       ← 对象1数据
3000002,T=lon|lat|alt|...       ← 对象2数据

#0.10                           ← 下一个时间帧
3000001,T=lon|lat|alt|...       ← 更新对象1
3000002,T=lon|lat|alt|...       ← 更新对象2
```

### 关键改进点
1. **帧同步**：所有对象在同一时间戳下更新
2. **批量发送**：减少socket调用次数
3. **数据完整性**：避免帧数据交错导致的解析错误

## 文件修改清单

- ✅ `task_allocation.py`
  - `TacviewStreamer.send_drone_data()` - 修改为返回数据行
  - `TacviewStreamer.send_frame_data()` - 新增批量发送方法
  - `DroneSimulation.update_positions()` - 修改为批量收集发送
  - 优化调试输出

## 兼容性

- ✅ 向后兼容：小规模场景（<30架）性能不受影响
- ✅ Tacview版本：支持 Tacview 1.8+
- ✅ Python版本：Python 3.6+
- ✅ Qt应用：无需修改C++代码

## 作者
修复日期：2025-11-08

## 备注
此修复同时提升了系统的可扩展性，理论上支持100+架飞机的态势推演。


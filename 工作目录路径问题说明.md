# 工作目录路径不一致问题说明

## 🐛 问题现象

用户看到的日志输出：
```
19:40:01 [信息] 态势文件：C:/Users/kevin/Desktop/dky(1)/dky/build-.../situation1.json
19:40:01 [信息] 控制文件：C:/Users/kevin/Desktop/dky(1)/dky/build-.../simulation_control.json
19:40:01 [信息] 工作目录：D:/DKY2/dky/dky/
```

**问题**：文件在C盘构建目录，但工作目录在D盘项目目录！

## 🔍 原因分析

### 代码逻辑（修复前）

```cpp
// 查找Python脚本
QString pythonScriptPath = appDir + "/task_allocation.py";  // C盘构建目录
QString workingDir = appDir;

if (!QFile::exists(pythonScriptPath)) {
    // 构建目录找不到，使用项目目录
    pythonScriptPath = PROJECT_ROOT_DIR + "task_allocation.py";  // D盘项目目录
    workingDir = PROJECT_ROOT_DIR;  // ❌ 工作目录也变成D盘
}

process->setWorkingDirectory(workingDir);  // 设置工作目录
```

### 问题根源

1. **构建目录**（C盘）没有 `task_allocation.py`
2. **回退到项目目录**（D盘）找到脚本
3. **工作目录也切换到项目目录**（D盘）❌

### 导致的问题

```
文件分布：
C盘 (构建目录):
  ├── jiemian1.exe              ← 应用程序
  ├── situation1.json           ← 态势文件
  └── simulation_control.json   ← 控制文件

D盘 (项目目录):
  ├── task_allocation.py        ← Python脚本
  └── task_allocation_output.json  ← Python输出（会在这里！）

结果：
- Python在D盘运行
- 读取C盘的文件
- 输出文件在D盘
- 文件散落两处 ❌
```

## ✅ 解决方案

### 修复后的代码

```cpp
// 查找Python脚本
QString pythonScriptPath = appDir + "/task_allocation.py";

if (!QFile::exists(pythonScriptPath)) {
    // 构建目录找不到，使用项目目录
    pythonScriptPath = PROJECT_ROOT_DIR + "task_allocation.py";
    
    if (!QFile::exists(pythonScriptPath)) {
        // 两处都找不到，报错
        QMessageBox::critical(this, "错误", "找不到Python脚本");
        return;
    }
    
    // 提示用户
    addLogMessage("提示：使用项目目录的Python脚本，建议复制到构建目录", "WARNING");
}

// ✅ 工作目录始终设置为应用程序目录
process->setWorkingDirectory(appDir);
```

### 关键改进

**不管脚本在哪里，工作目录始终是应用程序目录（C盘构建目录）**

```cpp
// ✅ 工作目录始终是应用程序目录
process->setWorkingDirectory(appDir);
```

## 📊 修复效果

### 修复前

```
19:40:01 [信息] 执行Python脚本：D:/DKY2/dky/dky/task_allocation.py
19:40:01 [信息] 态势文件：C:/.../situation1.json
19:40:01 [信息] 控制文件：C:/.../simulation_control.json
19:40:01 [信息] 工作目录：D:/DKY2/dky/dky/  ❌

Python输出文件位置：D:/DKY2/dky/dky/task_allocation_output.json  ❌
```

### 修复后

```
19:40:01 [信息] 执行Python脚本：D:/DKY2/dky/dky/task_allocation.py
19:40:01 [警告] 提示：使用项目目录的Python脚本，建议复制到构建目录  ← 新增提示
19:40:01 [信息] 态势文件：C:/.../situation1.json
19:40:01 [信息] 控制文件：C:/.../simulation_control.json
19:40:01 [信息] 工作目录：C:/.../build-jiemian1-.../  ✅

Python输出文件位置：C:/.../build-jiemian1-.../task_allocation_output.json  ✅
```

## 🎯 最佳实践

### 推荐方案1：复制Python脚本到构建目录

**手动复制**：
```
源文件：D:\DKY2\dky\dky\task_allocation.py
目标：C:\Users\kevin\Desktop\dky(1)\dky\build-jiemian1-...\task_allocation.py
```

**优点**：
- ✅ 所有文件在同一目录
- ✅ 不需要跨盘符访问
- ✅ 便于打包分发

### 推荐方案2：使用Qt构建后操作

在 `.pro` 文件中添加：

```qmake
# 构建后复制Python脚本
win32 {
    QMAKE_POST_LINK += $$quote(copy /Y $$shell_path($$PWD/task_allocation.py) $$shell_path($$OUT_PWD)$$escape_expand(\n\t))
}

unix {
    QMAKE_POST_LINK += cp $$PWD/task_allocation.py $$OUT_PWD/
}
```

**效果**：每次构建后自动复制

### 当前方案（已修复）：动态查找 + 固定工作目录

```cpp
// 优先使用构建目录脚本，否则使用项目目录脚本
// 但工作目录始终是构建目录
```

**优点**：
- ✅ 无需手动复制
- ✅ 输出文件位置统一
- ✅ 向后兼容

**缺点**：
- ⚠️ 跨盘符访问（可能略慢）

## 📝 日志对比

### 理想状态（脚本在构建目录）

```
[信息] 执行Python脚本：C:/.../build-jiemian1-.../task_allocation.py  ← C盘
[信息] 态势文件：C:/.../build-jiemian1-.../situation1.json         ← C盘
[信息] 控制文件：C:/.../build-jiemian1-.../simulation_control.json  ← C盘
[信息] 工作目录：C:/.../build-jiemian1-.../                        ← C盘

所有文件在同一目录 ✅
```

### 当前状态（脚本在项目目录，已修复）

```
[信息] 执行Python脚本：D:/DKY2/dky/dky/task_allocation.py          ← D盘
[警告] 提示：使用项目目录的Python脚本，建议复制到构建目录         ← 新增提示
[信息] 态势文件：C:/.../build-jiemian1-.../situation1.json         ← C盘
[信息] 控制文件：C:/.../build-jiemian1-.../simulation_control.json  ← C盘
[信息] 工作目录：C:/.../build-jiemian1-.../                        ← C盘 ✅

输出文件会在工作目录（C盘） ✅
```

## 🔧 文件修改

### mainwindow.cpp

**行564-565**：
```cpp
// 工作目录始终设置为应用程序目录（确保输出文件在正确位置）
process->setWorkingDirectory(appDir);  // ← 不再是 workingDir
```

**行560-561**：
```cpp
// 如果使用项目根目录的脚本，提示用户
addLogMessage("提示：使用项目目录的Python脚本，建议复制到构建目录", "WARNING");
```

## 💡 建议

### 对于开发者
- ✅ 将 `task_allocation.py` 复制到构建目录
- ✅ 或者使用Qt构建后操作自动复制

### 对于发布
- ✅ 打包时包含 `task_allocation.py`
- ✅ 确保在同一目录

### 当前临时方案
- ✅ 代码已修复，工作目录统一
- ⚠️ 建议复制脚本到构建目录（性能更好）

## 🎉 总结

### 问题
- ❌ 工作目录不一致（D盘）
- ❌ 文件散落两处
- ❌ 输出位置混乱

### 修复
- ✅ 工作目录统一为应用程序目录（C盘）
- ✅ 输出文件位置统一
- ✅ 添加警告提示

### 建议
- 📌 复制 `task_allocation.py` 到构建目录
- 📌 所有文件在同一位置更佳

---

**修复日期**：2025-11-08  
**影响范围**：工作目录设置、输出文件位置


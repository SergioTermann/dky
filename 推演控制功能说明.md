# 推演控制功能说明

## 🎮 功能概述

实时控制推演的暂停/继续和倍速调整功能，通过控制文件（`simulation_control.json`）实现 C++ 界面与 Python 推演脚本的通信。

## ⚙️ 控制选项

### 1. 暂停/继续按钮 ⏸️ ▶️

**功能**：
- 点击"暂停"：推演暂停，不再计算飞机位置，不发送数据给 Tacview
- 点击"继续"：推演恢复，继续计算和发送

**实现原理**：
- 界面按钮切换 `isPaused` 状态
- 更新 `simulation_control.json` 文件
- Python 脚本每 0.5 秒读取控制文件
- 暂停时跳过飞机位置计算和 Tacview 数据发送

### 2. 倍速选择 ⚡

**倍速档位**：
- 🐌 **0.5x** - 慢速（适合观察细节）
- ⏩ **1x** - 正常速度（默认）
- ⚡ **2x** - 2倍速
- 🚀 **5x** - 5倍速
- 💨 **10x** - 10倍速（快速推演）

**实现原理**：
```python
# 基础时间间隔
base_interval = 0.1秒

# 根据倍速调整
adjusted_interval = base_interval / speed_multiplier

# 示例：
# 1x  → 0.1秒/帧
# 2x  → 0.05秒/帧（速度加倍）
# 10x → 0.01秒/帧（10倍速）
```

## 📊 技术实现

### 控制文件格式

`simulation_control.json`:
```json
{
  "paused": false,
  "speed_multiplier": 1.0,
  "timestamp": "2025-11-08T12:30:45",
  "blue_task_mode": "defense",
  "red_task_mode": "attack"
}
```

### C++ 端（mainwindow.cpp）

**暂停/继续处理**：
```cpp
void MainWindow::on_pauseResumeButton_clicked()
{
    isPaused = !isPaused;
    
    if (isPaused) {
        ui->pauseResumeButton->setText("▶️ 继续");
        addLogMessage("推演已暂停", "INFO");
    } else {
        ui->pauseResumeButton->setText("⏸️ 暂停");
        addLogMessage("推演已继续", "INFO");
    }
    
    updateSimulationControlFile();  // 立即更新控制文件
}
```

**倍速调整处理**：
```cpp
void MainWindow::on_speedComboBox_currentIndexChanged(int index)
{
    switch (index) {
        case 0: speedMultiplier = 0.5; break;
        case 1: speedMultiplier = 1.0; break;
        case 2: speedMultiplier = 2.0; break;
        case 3: speedMultiplier = 5.0; break;
        case 4: speedMultiplier = 10.0; break;
    }
    
    updateSimulationControlFile();  // 立即更新控制文件
}
```

### Python 端（task_allocation.py）

**定期读取控制文件**：
```python
def _read_control_file(self):
    """每0.5秒读取一次控制文件"""
    try:
        with open(self.control_file_path, 'r', encoding='utf-8') as f:
            control_data = json.load(f)
        
        old_paused = self.is_paused
        old_speed = self.speed_multiplier
        
        self.is_paused = control_data.get('paused', False)
        self.speed_multiplier = control_data.get('speed_multiplier', 1.0)
        
        # 检测状态变化并打印提示
        if old_paused != self.is_paused:
            print('⏸️ 推演已暂停' if self.is_paused else '▶️ 推演已继续')
        
        if old_speed != self.speed_multiplier:
            print(f'⚡ 倍速: {old_speed}x → {self.speed_multiplier}x')
    except:
        pass  # 读取失败使用默认值
```

**推演循环控制**：
```python
def update_positions(self, steps=100):
    for step in range(steps):
        # 1. 定期检查控制文件
        if current_time - self.last_control_check_time >= 0.5:
            self._read_control_file()
        
        # 2. 暂停时跳过计算
        if self.is_paused:
            time.sleep(0.1)
            continue  # 跳过本帧
        
        # 3. 正常计算飞机位置
        # ... 飞机位置更新 ...
        
        # 4. 发送数据给 Tacview
        if self.tacview_streamer.is_connected:
            self.tacview_streamer.send_frame_data(...)
        
        # 5. 根据倍速调整等待时间
        adjusted_interval = 0.1 / self.speed_multiplier
        time.sleep(adjusted_interval)
```

## 🎯 使用场景

### 场景1：观察特定时刻
1. 推演运行中
2. 发现感兴趣的态势
3. **点击"暂停"** → 态势定格
4. 在 Tacview 中仔细观察
5. **点击"继续"** → 推演继续

### 场景2：快速跳过初始阶段
1. 推演开始
2. 初始阶段飞机只是飞向目标
3. **选择"10x"倍速** → 快速推演
4. 接近目标区域时
5. **选择"1x"** → 正常速度观察

### 场景3：慢动作回放
1. 推演到关键时刻
2. **选择"0.5x"** → 慢速播放
3. 仔细观察战术动作
4. 观察完毕后恢复正常速度

## 🔄 数据流

```
┌─────────────┐        ┌──────────────────┐        ┌──────────────┐
│   界面操作   │  ───▶  │ simulation_      │  ───▶  │  Python推演  │
│  点击按钮   │        │ control.json     │        │   读取并应用  │
└─────────────┘        └──────────────────┘        └──────────────┘
                              │                            │
                              │                            ▼
                              │                     ┌──────────────┐
                              └────────────────────▶│   Tacview    │
                                控制数据输出         │  实时显示    │
                                                    └──────────────┘
```

## 📝 日志输出

### 界面日志（C++）：
```
[INFO] 推演已暂停
[INFO] 推演已继续
[INFO] 推演倍速已设置为 2x
[INFO] 推演倍速已设置为 10x
```

### 控制台日志（Python）：
```
======================================================================
⏸️  【推演已暂停】
======================================================================

======================================================================
▶️  【推演已继续】
======================================================================

⚡ 推演倍速已调整: 1.0x → 2.0x

  仿真进度: 50/1000 步 (5.0%) [2.0x]
  仿真进度: 100/1000 步 (10.0%) [2.0x]
```

## ⚠️ 注意事项

1. **响应延迟**：控制文件每 0.5 秒检查一次，实际响应可能有 0.5 秒延迟
2. **暂停状态**：暂停时不发送数据给 Tacview，Tacview 画面保持静止
3. **倍速限制**：倍速过快（如 10x）可能导致飞行轨迹不够平滑
4. **文件读写**：确保 `simulation_control.json` 文件可读写

## 🚀 优势

✅ **实时控制**：无需重启推演，动态调整
✅ **平滑切换**：暂停/继续无缝衔接
✅ **灵活倍速**：支持 0.5x ~ 10x 多档调速
✅ **Tacview 同步**：控制与可视化完全同步
✅ **状态提示**：清晰的日志和界面反馈

## 📚 相关文件

- `mainwindow.cpp` - 界面控制逻辑
- `task_allocation.py` - 推演执行逻辑
- `simulation_control.json` - 控制文件（自动生成）
- `TACVIEW_FIX_README.md` - Tacview 数据发送说明


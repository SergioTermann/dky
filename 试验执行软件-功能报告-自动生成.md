# 动态场景生成平台 - 试验执行软件功能报告

**文档版本**：v1.0  
**生成日期**：2025年11月13日  
**软件版本**：v1.0  

---

## 1. 系统概述

### 1.1 系统简介

本系统为动态场景生成与试验执行软件，是一套集成化的红蓝对抗态势推演平台。系统基于 C++/Qt 框架构建用户交互界面，联合 Python 高性能计算引擎实现任务分配与实时仿真，支持从态势创建、智能生成、博弈论任务分配到三维可视化回放的完整闭环流程。系统采用 JSON/XML 作为主要数据交换格式，通过 `simulation_control.json` 文件实现跨进程的实时控制与态势同步，内置 Tacview 实时数据流输出接口，为试验执行提供端到端的技术支撑。

相对于传统态势推演方案，本系统在算法层面采用属性加权快速评分方法替代计算密集型的 Shapley 值精确求解，使得百架级别的大规模推演能够在可接受的时延内完成，性能提升达到 10-100 倍。在工程实现上，系统提供倍速调节、暂停恢复、多任务模式切换、在线调试等高级功能，满足试验筹划、执行与复盘的多样化需求。系统架构强调模块化与可扩展性，为后续引入更复杂的智能决策模型、多域协同机制以及分布式计算能力预留了充足的扩展空间。

### 1.2 系统架构

系统采用前后端分层架构设计，实现界面展示与计算逻辑的有效解耦。前端界面层由 Qt 框架实现（核心模块包括 `mainwindow.cpp/h`、`aircraftmodel.cpp/h`、`situationgenerator.cpp/h`），负责红蓝双方态势数据的表格化维护、参数配置、推演控制以及统计信息展示。界面层提供直观的增删改查操作，并对用户输入进行实时校验，确保经纬度、高度、速度、航向等关键参数符合物理约束与业务规则。

后端算法与推演引擎由 Python 实现（主要文件为 `task_allocation.py`），包含态势数据加载、坐标系统转换、无人机属性计算、基于博弈论的快速任务分配算法以及基于飞行动力学的实时仿真推演。Python 引擎通过读取 JSON/XML 态势文件获取初始数据，经过任务分配计算后输出分组结果与统计指标，随后启动仿真循环并持续输出态势更新。

前后端通过文件系统与本地网络进行耦合。界面侧通过更新 `simulation_control.json` 文件实现对推演进程的实时控制，包括暂停/继续标志、倍速因子以及蓝方任务模式等关键参数；Python 引擎在仿真循环中定期读取该文件，检测到变更后立即应用新配置，实现毫秒级的控制响应。可视化方面，系统通过 Tacview 实时数据流接口（默认监听 127.0.0.1:58008）输出符合 ACMI 2.1 规范的三维态势数据；同时通过本地 UDP 广播（默认端口 10114）发送 JSON 格式的态势快照，供在线调试模块与外部系统订阅使用。

在线调试子系统包含 UDP 协议适配、HTTP 链路测试与本地模拟服务三个组件，支持与远端试验平台的双向通信、消息解析与格式转换，便于系统级联调与协议压力测试。整体架构遵循"松耦合、高内聚"原则，各模块职责清晰，接口规范明确，具备良好的可维护性与可扩展性。

### 1.3 技术特点

系统技术特点可归纳为"大规模、实时、可视化、可联调"四个维度。在数据处理能力方面，系统支持单方最多 9999 架飞机的态势管理与推演，通过批量帧同步机制优化了 Tacview 数据流的发送效率，避免了传统逐架发送导致的帧头混乱与渲染延迟，在 100 架以上的大规模场景下依然保持稳定输出。在算法性能方面，快速评分方法基于机动性、动力与距离等物理属性进行加权计算，将传统 Shapley 值的指数级复杂度降低至线性级别，使任务分配时间从分钟级缩短至秒级，显著提升了态势生成与推演的迭代效率。

在实时控制方面，系统采用外部 JSON 文件作为控制通道，实现了 Qt 界面与 Python 引擎之间的低耦合、高响应通信。用户在界面上的暂停、倍速调节与任务模式切换操作能够在 0.5 秒内传递至推演进程并生效，无需重启或手动干预。这种设计使得试验执行人员能够根据态势演化实时调整推演节奏，提高试验效率与数据采集灵活性。

在可视化方面，系统集成了业界标准的 Tacview 三维回放工具，通过 TCP 实时流协议输出符合 ACMI 规范的飞行数据。系统对每帧数据进行批量封装，确保同一时间戳下的所有飞机状态同步更新，避免了逐架发送导致的时间戳不一致问题。同时，系统启用了 TCP_NODELAY 选项并扩大了发送缓冲区，针对大机群场景进行了专门优化。Tacview 日志文件 `tacview_data_log.txt` 记录了每帧的发送时间、数据量与传输耗时，为性能分析与瓶颈定位提供了详实依据。

在工程化与联调支持方面，系统提供了 Conda 环境启动脚本、端口约定文档以及在线调试套件。`run_simulation_temp.bat` 脚本能够自动激活 Python 环境并启动推演程序，降低了部署与操作门槛。在线调试模块支持 UDP 二进制协议与 HTTP JSON 协议的双向转换，能够适配远端试验平台的消息格式，实现节点注册、管控指令、心跳上报与态势转发等完整功能，便于系统间互联互通与协议一致性验证。

## 2. 功能模块

### 2.1 红方态势管理模块

红方态势管理模块是系统的数据输入核心，负责红方飞机编队的完整生命周期管理。模块采用 Qt Model-View 架构，通过 `AircraftModel` 类实现数据与界面的分离，表格控件 `QTableView` 作为展示层，支持直接编辑与批量操作。每架飞机实体包含八个核心属性字段：唯一标识 ID（整型，自动递增）、飞机型号（字符串，可自定义）、地理经度（浮点型，度数，有效范围 -180 至 +180）、地理纬度（浮点型，度数，有效范围 -90 至 +90）、飞行高度（浮点型，米，非负）、飞行速度（浮点型，千米每小时，非负）、飞行航向（浮点型，度数，有效范围 0 至 360，北向为 0 度顺时针）以及飞行状态（字符串枚举，包括"待命"、"巡航"、"战斗"等）。

系统对所有数值字段实施严格的实时校验机制。当用户在表格单元格中输入数据时，`AircraftModel::setData` 方法会拦截输入并执行多层验证：首先检查非空约束，防止关键字段留白；其次使用正则表达式验证数值格式，确保只包含数字、小数点与必要的负号；最后执行范围校验，对超出物理或业务约束的值予以拒绝并弹出详细的错误提示对话框，说明当前输入值、有效范围以及修正建议。这种即时反馈机制有效避免了无效数据进入后续计算流程，保障了态势数据的质量与一致性。

用户可以通过"添加飞机"按钮快速插入新行，系统自动分配递增 ID 并填充默认值，用户只需逐字段修改即可完成录入。对于大批量态势数据，系统支持从外部 JSON 或 XML 文件加载。JSON 格式支持纯数组结构或包含 `red_aircraft` 键的对象结构，后者可同时携带生成参数与任务模式配置。XML 格式遵循标准的层次化节点结构，系统使用 `QXmlStreamReader` 进行解析，能够容错处理常见的格式瑕疵。加载完成后，系统自动更新表格显示，并同步调整 ID 生成器的起始值，确保新增飞机不会与已有 ID 冲突。

界面底部的状态栏实时呈现红方编队的统计信息。左侧显示飞机总数，中部显示综合评分，右侧显示当前系统时间。评分算法综合考虑多个维度：基础分数按每架飞机 10 分计；高度评分根据飞行高度分段赋分，10000 米以上加 20 分，5000-10000 米加 15 分，2000-5000 米加 10 分，2000 米以下加 5 分；速度评分按照 800、600、400 千米每小时三个阈值分段，最高加 15 分；状态评分按"战斗"、"巡航"、"待命"三个等级分别加 15、10、5 分；此外，系统对编队规模给予数量优势加成，10 架以上每架额外加 5 分，5-10 架加 3 分，3-5 架加 2 分。这种多维评分体系能够综合反映编队的高度优势、速度优势、战斗准备状态以及编队规模效应，为态势平衡性分析提供量化依据。

### 2.2 蓝方态势生成模块
蓝方态势由 `SituationGenerator` 基于红方数据自动生成，若用户未显式给定数量与策略，系统将采用默认策略：建议蓝方数量等于红方数量加二，建议难度为“中等”。生成算法会在给定地理范围内随机化蓝方经纬高、速度与航向，形成可对抗的起始阵位，并将结果回写至界面蓝方表格。最终生成可保存为 JSON 或 XML 文件，并在界面以建议标签提示采用的数量与策略，从而实现“自动推荐、可手动覆盖”的灵活流程。

### 2.3 任务分配模块

任务分配模块是系统的智能核心，负责将红方攻击无人机与蓝方防御无人机按照博弈论原则进行最优分组配对。模块由 Python 类 `GameBasedTaskAllocation` 实现，采用改进的快速评分算法替代传统 Shapley 值精确计算。传统 Shapley 值方法需要遍历所有可能的联盟组合，时间复杂度为 O(2^n × n!)，在飞机数量超过 20 架时计算耗时呈指数级增长，难以满足实时推演需求。本系统提出的快速评分方法基于无人机的物理属性进行加权求和，将复杂度降低至 O(n)，在保证分配质量的前提下实现了 10-100 倍的性能提升。

快速评分算法首先对每架无人机计算三项基础属性：机动性（mobility）基于速度归一化至 [0, 1]，假设最大速度为 1000 千米每小时；动力（power）基于高度归一化至 [0, 1]，假设最大高度为 10000 米；距离因子（distance_factor）基于到目标区域的欧氏距离计算，采用反比例函数 1/(1 + d/50) 进行归一化。综合评分为三项属性的加权和，默认权重为机动性 35%、动力 35%、距离 30%。对于攻击型无人机，系统额外增加机动性与动力的加成（分别为 15% 和 10%）；对于防御型无人机，系统增强动力与位置的加成（分别为 15% 和 10%）。评分结果经过归一化限制在 [0.1, 2.0] 区间，避免极端值影响后续分组决策。

任务分配支持三种模式，分别适应不同的战术场景。攻击模式（attack）适用于红方主动进攻、蓝方被动防御的态势，算法优先考虑攻击能力集中与距离容忍，允许多架攻击无人机分配至同一防御组，负载因子设置为宽松策略（2 架以内负载因子 1.0，2-4 架降至 0.8，4 架以上降至 0.5），距离匹配度使用 30 千米的容忍半径。防御模式（defense）适用于红方防御阵地、蓝方主动来袭的态势，算法强调严格的负载平衡与距离敏感，优先为空载或低载的防御组分配攻击无人机，负载因子采用严格策略（0 架负载因子 1.0，1 架降至 0.6，2 架降至 0.3，3 架以上降至 0.1），距离匹配度使用 15 千米的敏感半径。对抗模式（confrontation）适用于双方势均力敌、攻防平衡的态势，算法在攻防能力与负载均衡之间寻求折中，负载因子与距离参数取中间值。

分配流程分为五个阶段：初始化阶段以每个防御无人机为核心建立空分组；威胁度排序阶段按快速评分值对攻击无人机降序排列，优先分配高威胁目标；贪心分配阶段遍历攻击无人机列表，为每架无人机计算所有分组的匹配度（综合负载因子、防御能力匹配与距离匹配），选择匹配度最高的分组加入；平衡性验证阶段计算组间负载标准差与平衡比，若平衡比低于 0.6 或存在多个空载组，则触发重平衡；重平衡阶段从过载组中选择威胁度较低的攻击无人机转移至欠载组，最多执行 20 次转移操作以避免陷入局部震荡。最终输出包含每组的防御无人机列表、攻击无人机列表、Shapley 估计值、组规模、攻击负载以及平均机动性、平均动力、平均距离等统计指标，为态势分析与可视化提供结构化数据。

### 2.4 推演仿真模块

推演仿真模块负责无人机编队的动态运动模拟，基于简化的飞行动力学模型实现平滑、可信的轨迹生成。模块由 Python 类 `DroneSimulation` 实现，从任务分配结果中提取初始位置与速度信息，建立局部坐标系统（以目标区域为原点的二维平面），并在每个时间步执行位置更新、速度调整与航向修正。仿真采用固定时间步长 0.1 秒，默认推演总步数为 1000 步（对应 100 秒实时时间），用户可通过界面倍速控制实际推演时长。

飞行动力学模型包含四个关键约束参数：最大速度设为 15 千米每小时（对应约 4.2 米每秒），最大加速度设为 8 米每秒平方，最大角速度设为 45 度每秒，平滑因子设为 0.15。速度控制采用渐进式调整策略，系统首先计算期望速度向量（基于当前航向与目标速度），然后计算速度差并乘以加速度系数（默认 2.0）得到期望加速度，再通过限幅函数将加速度限制在最大值内，最后应用平滑因子进行指数加权平均，避免速度突变引起的抖动。航向控制采用角速度限制与角度归一化策略，系统计算目标方向与当前航向的夹角差（考虑 360 度跨越问题），将角度差映射至 [-180, 180] 区间，然后计算期望角速度并限制在最大角速度内，通过积分更新航向角并归一化至 [0, 360) 区间。

编队协同机制通过目标导向与编队中心导向的加权融合实现。系统首先计算每个分组的几何中心（取组内所有无人机位置的平均值），然后为每架无人机计算两个导向向量：目标导向指向预设的目标区域中心（默认坐标 80, 80），权重为 70%；编队导向指向所属分组的几何中心，权重为 30%，但只有在距离编队中心超过 5 千米时才激活，避免近距离扰动。两个导向向量加权求和后归一化，得到最终的期望航向，无人机将平滑转向该方向并调整速度以接近目标。这种机制既保证了编队整体朝向目标区域推进，又维持了组内成员的相对聚合，模拟了真实编队的协同飞行行为。

推演过程中，系统每隔 0.5 秒读取一次控制文件 `simulation_control.json`，检测暂停标志、倍速因子与任务模式的变化。当检测到暂停标志为真时，系统进入空转循环，持续休眠但不推进仿真时间，也不发送 Tacview 数据；当检测到恢复标志时，系统打印日志并继续推演。倍速调节通过调整休眠时长实现：基础间隔为 0.1 秒，实际间隔等于基础间隔除以倍速因子，例如 2x 倍速时间隔为 0.05 秒，10x 倍速时间隔为 0.01 秒。这种控制机制使得试验执行人员能够在推演过程中灵活调节节奏，无需中断或重启进程。

每个仿真步结束后，系统通过本地 UDP 套接字向端口 10114 广播当前态势数据。广播消息为 JSON 格式，包含时间戳（Unix 毫秒）、红方飞机列表与蓝方目标列表。每架飞机/目标包含平台 ID、经纬度、高度、速度、航向、横滚角与俯仰角等字段，供在线调试模块与外部监控系统订阅使用。广播操作采用"发送即忘"策略，不等待确认，确保推演主循环不受网络延迟影响。

### 2.5 Tacview 可视化模块

Tacview 可视化模块是系统的三维态势输出接口，负责将仿真过程实时传输至 Tacview 软件进行三维场景渲染。模块由 Python 类 `TacviewStreamer` 实现，遵循 ACMI（Air Combat Maneuvering Instrumentation）2.1 文本流协议规范。系统在独立线程中启动本地 TCP 服务器，默认监听地址为 127.0.0.1:58008，等待 Tacview 客户端连接。为适配大机群场景，服务器套接字将发送缓冲区扩大至 512KB，并对客户端连接启用 TCP_NODELAY 选项以禁用 Nagle 算法，减少小数据包的延迟积累。

连接建立后，系统按照 Tacview 协议执行四阶段握手流程。第一阶段发送三行协议标识字符串（XtraLib.Stream.0、Tacview.RealTimeTelemetry.0、alpha_dog_fight）以及一个 NULL 字节，声明流类型与版本；第二阶段接收客户端的握手响应并校验；第三阶段发送文件头（FileType=text/acmi/tacview、FileVersion=2.1）与参考时间（0,ReferenceTime=YYYY-MM-DDTHH:MM:SSZ）；第四阶段发送数据标题（0,Title = test simple aircraft）并等待客户端准备就绪。握手完成后，系统打印成功消息并打开数据日志文件 `tacview_data_log.txt`，记录后续发送的所有帧数据。

每个仿真步，系统调用 `send_frame_data` 方法批量发送整帧数据。该方法首先收集所有无人机的数据行，每架无人机调用 `send_drone_data` 方法生成一行文本，格式为：对象ID,T=经度|纬度|高度|横滚|俯仰|航向,Type=Air+FixedWing,Coalition=Enemies,Color=红/蓝,Name=F-16,Mach=马赫数,ShortName=显示名称,RadarMode=1,RadarRange=2000 等字段。红方飞机对象 ID 范围为 1-9999，蓝方对象 ID 范围为 10001-19999，确保双方 ID 不冲突且分布清晰。收集完成后，系统在数据行前插入统一的时间戳帧头（格式为 #timestamp），将整个消息编码为 UTF-8 字节流，通过 `sendall` 方法确保完整发送。

系统对每帧发送进行性能监控，记录发送起止时间并计算传输耗时（毫秒），每 20 帧打印一次统计信息，包括当前帧号、飞机数量、本帧数据大小、平均数据大小、本帧传输时间与平均传输时间。这些指标为性能调优与瓶颈定位提供了量化依据。在 30 架以上的大机群场景下，系统通过批量帧同步机制成功解决了传统逐架发送导致的帧头混乱问题，显著提升了 Tacview 的渲染流畅度与数据一致性。

目标区域中心点在握手完成后单独发送，格式为：1000000,T=经度|纬度|0, Type=Ground+Static+Building, Name=Competition, EngagementRange=30000。该对象使用固定 ID 1000000，类型标记为地面静态建筑物，在 Tacview 中以特殊图标显示，作为编队导航的参考点。所有数据帧同时写入日志文件，每帧记录时间戳、飞机数量与数据大小，便于事后回溯与数据复现。

### 2.6 文件管理模块
系统全面支持 JSON 与 XML 两种格式。在保存时，既可保存纯红蓝列表，也可在根对象下保存 `red_aircraft`、`blue_aircraft` 与 `parameters` 三段结构，`parameters` 中包含蓝方数量与策略等生成参数，同时在“保存全部数据”时还会记录任务模式字段。加载时系统兼容纯数组与对象两种 JSON 格式，并能从 XML 中解析对应节点。加载完成后，若文件含任务模式，界面会自动同步红蓝两侧的模式选择，并静默更新控制文件，确保后续推演一致。

### 2.7 在线调试模块

在线调试模块是系统与外部试验平台互联的桥梁，支持 UDP 二进制协议与 HTTP JSON 协议两种通信方式。核心脚本 `online_debug.py` 实现了完整的 UDP 协议栈，能够解析远端试验系统发送的试验准备消息（MsgID 0x0001）、试验管控消息（MsgID 0x0003）、节点注册响应（MsgID 0x0006）、心跳上报（MsgID 0x0008）以及倍速调节消息（MsgID 0x0009），并构造相应的响应消息回传。消息格式遵循二进制协议规范，包含 26 字节的固定消息头（消息 ID、源平台代码、目标平台代码、序列号、创建时间戳、分包信息与数据长度）以及变长的消息体。系统使用 `struct` 模块进行字节流的打包与解包，确保字段对齐与字节序正确。

模块启动时首先创建 UDP 套接字并绑定本地监听地址（默认 127.0.0.1:10113），然后向远端地址（默认为试验平台地址）发送节点注册消息（MsgID 0x0005），声明节点类型、IP 地址、端口与节点名称。注册成功后，模块启动三个守护线程：本地服务器线程监听远端消息并解析；态势监听线程订阅 `task_allocation.py` 广播的红蓝态势数据（本地 UDP 127.0.0.1:10114）；心跳线程每 10 秒向远端发送心跳消息以维持连接活跃。当态势监听线程接收到态势数据后，系统将 JSON 格式的飞机数据转换为二进制格式的平台状态消息（MsgID 0x1001，包含时间、平台 ID、经纬度、高度、速度、航向、横滚、俯仰、编队信息、任务、电量、武器等 59 字节消息体）以及蓝方目标状态消息（MsgID 0x1000，包含时间、目标 ID、经纬度、高度、速度、航向、横滚、俯仰、目标类型等 35 字节消息体），通过 UDP 套接字回传远端。

辅助脚本 `http_connect.py` 提供 HTTP 协议测试功能，使用 `requests` 库向指定的 HTTP 端点发送 POST 请求，请求体为 JSON 格式的状态消息（包含节点名称、IP、端口、分类、版本、网络信息、CPU 使用率、内存使用率、GPU 使用率等字段），用于验证 HTTP 链路的连通性与消息格式的兼容性。脚本采用会话（Session）方式管理 HTTP 连接，禁用系统代理以避免 502 网关错误，并设置 5 秒超时以防止阻塞。

本地模拟服务器脚本 `mock_remote_server.py` 用于在无远端平台时进行闭环测试，模拟远端接收节点注册、平台状态与管控反馈消息，并主动向调试端发送试验管控指令。脚本监听 UDP 端口（默认 1007），解析接收到的二进制消息并打印详细字段，包括平台 ID、经纬度、速度、航向、节点类型、注册结果等。当接收到首条消息后，模拟服务器自动发送"试验开始"指令（ControlType=1），触发调试端启动 `task_allocation.py` 脚本。用户可通过修改脚本发送不同的管控类型（1=开始、2=暂停、3=恢复、4=结束、5=一键返航），验证消息解析与执行流程的正确性。

### 2.8 日志系统模块

日志系统模块贯穿界面与后台两侧，提供分级、可追溯的操作记录。界面日志面板采用富文本控件 `QTextEdit`，支持 HTML 格式的彩色输出。系统定义了四个日志级别：信息（INFO，灰色）、成功（SUCCESS，绿色）、警告（WARN，黄色）与错误（ERROR，红色），每条日志包含时间戳（精确到秒）、级别标签与消息内容。界面在关键操作点自动记录日志，包括飞机增删、文件加载保存、态势生成、推演启动、参数调整等。日志面板提供自动滚动选项（默认开启），新日志到达时自动滚动至底部；提供日志计数标签，实时显示已记录的日志条数；提供清空按钮，一键清除所有历史日志。用户可通过菜单栏的"切换日志面板"选项（快捷键 Ctrl+L）隐藏或显示日志区域，优化界面空间利用。

Python 后台在关键执行阶段打印进度与统计信息。任务分配阶段打印飞机总数、评分计算耗时以及性能提升百分比；推演阶段每 50 帧打印一次进度百分比与当前倍速；Tacview 发送阶段每 20 帧打印一次帧号、飞机数量、数据大小与传输耗时。所有 Tacview 帧数据同步写入文件 `tacview_data_log.txt`，该文件包含文件头信息（开始时间、版本号）、每帧详细数据（时间戳帧头与所有对象数据行）以及尾部信息（结束时间、统计摘要）。日志文件采用 UTF-8 编码，便于使用文本编辑器查看与搜索。在大机群条件下，日志文件可达到数十 MB，记录了完整的 Tacview 数据流历史，为性能分析、协议调试与数据复现提供了可靠依据。

## 3. 操作流程

### 3.1 基本操作流程
用户首先在界面启动程序，进入红方态势管理页，点击添加按钮创建红方飞机并在表格中编辑经纬高、速度、航向与状态；当红方数据准备就绪后，可直接点击“生成态势文件”，若未设置蓝方数量与策略，系统将采用自动推荐并展示建议值，同时在界面蓝方表格中填充生成结果；随后在界面选择任务模式与倍速，点击“开始推演”按钮，系统会在新终端中启动 Python 引擎并加载最新的控制与态势文件，Tacview 若连接到 127.0.0.1:58008 即可实时显示；在推演过程中，用户可随时使用“暂停/继续”按钮以及倍速下拉框调节进程，界面会实时写入控制文件，Python 引擎检测到变化后即时生效。

### 3.2 高级操作流程
对于已有态势，用户可通过“加载红方态势”直接导入 JSON 或 XML 文件，系统将解析并填充红方表格，并在文件包含任务模式时自动同步红蓝两侧模式以保持逻辑对称；当需要批量导入时，推荐使用包含 `red_aircraft` 与 `blue_aircraft` 的对象格式，这样可以在一次加载中恢复双方初始阵位与生成参数；在模型分析方面，界面会展示红蓝评分，用户可在生成前后对比两侧评分，借此评估态势平衡性，并结合不同任务模式启动推演以观察分配策略在攻防、对抗等不同配置下的差异。

## 4. 技术规格

### 4.1 系统要求
推荐在 Windows 10/11 环境运行，界面使用 Qt 5/6 版本，Python 侧建议 Python 3.7+ 并按 `run_simulation_temp.bat` 方式启动以激活 Conda 环境 ppoa。依赖方面，Python 主要使用 NumPy、JSON、socket、tkinter 等标准或常用库；C++ 侧依赖 Qt 核心模块及 JSON/XML 读写。Tacview 需要 1.8+ 版本以支持实时流导入。

### 4.2 性能指标
系统在 100 架规模内能够以较高稳定性完成态势生成与任务分配，Tacview 批量帧同步策略显著降低了因帧头重复导致的显示异常与积压。默认 1x 倍速时，推演时间步为 0.1 秒，控制文件倍速与暂停在半秒内响应，UDP 广播每步一次，Tacview 帧日志显示平均传输时间与数据量，便于评估瓶颈。

### 4.3 数据格式
系统以经纬度为主坐标，默认参考点为北纬 39.53°、东经 115.7°，在该纬度下 1 度经度约合 85.5 千米、1 度纬度约合 111 千米。界面与文件采用度与米、千米每小时等常用量纲，Python 引擎内部在必要时进行局部坐标换算，用于飞行动力学与可视化变量计算。单位规范在 JSON/XML 中保持直观表达，使数据可读性与跨系统兼容性兼顾。

### 4.4 接口规范
控制接口为本地 `simulation_control.json`，包含暂停标志、倍速因子与蓝方任务模式等关键字段，界面每次操作都会刷新时间戳并写入，Python 侧定期读取执行。态势广播为本地 UDP JSON，端口默认 10114，消息包含时间戳、红方飞机列表与蓝方目标列表，供在线调试与外部系统复用。Tacview 实时流采用本地 TCP（127.0.0.1:58008），帧格式遵循 ACMI 文本流规范，系统严格按单帧单时间戳的方式批量发送，保证大规模对象同步更新。

## 5. 常见问题与解决方案

### 5.1 态势生成相关问题

**问题**：点击"生成态势文件"后提示"红方态势数据为空"。  
**原因**：未添加红方飞机或红方表格已被清空。  
**解决方案**：在生成蓝方态势前，必须先在红方表格中添加至少一架飞机。可通过"添加飞机"按钮手动录入，或使用"加载红方态势"菜单从文件导入。检查红方表格是否显示数据，确认统计标签中的飞机数量大于零。

**问题**：生成的蓝方飞机位置过于分散或集中，不符合预期战术部署。  
**原因**：`SituationGenerator` 使用的地理范围参数与实际需求不匹配。  
**解决方案**：当前算法在经度 110±5 度、纬度 35±5 度范围内随机生成。如需调整分布密度，可修改 `situationgenerator.cpp` 中的 `lonRange` 与 `latRange` 参数；如需改变集中位置，修改 `centerLon` 与 `centerLat` 参数。修改后重新编译 Qt 程序或在 Python 侧扩展态势生成脚本。

**问题**：界面推荐的蓝方数量与用户设定差异较大。  
**原因**：系统采用"红方数量+2"的默认策略，适用于平衡对抗场景，但可能不适配特定战术需求。  
**解决方案**：忽略推荐值，直接在"蓝方数量"输入框中填入所需数值，系统将优先使用用户指定值。生成后可在蓝方表格中手动增删单架飞机，或调整难度策略重新生成。

### 5.2 推演控制相关问题

**问题**：点击"开始推演"按钮后无反应，终端未弹出或Python脚本未启动。  
**原因**：可能是 Conda 环境未激活、脚本路径错误或系统权限不足。  
**解决方案**：首先检查 `task_allocation.py` 文件是否存在于项目根目录（默认 `C:/Users/kevin/Desktop/dky/`）；其次确认 Conda 环境 ppoa 已正确安装并可通过命令行激活；第三检查 `mainwindow.cpp` 中的 `PROJECT_ROOT_DIR` 常量是否匹配实际路径；最后尝试手动运行 `run_simulation_temp.bat` 批处理脚本，观察终端输出的错误信息。

**问题**：推演过程中点击"暂停"按钮无效，仿真继续运行。  
**原因**：控制文件写入失败或Python引擎未正常读取 `simulation_control.json`。  
**解决方案**：首先检查项目根目录下 `simulation_control.json` 文件的修改时间戳，确认界面操作时文件已更新；其次检查文件读写权限，确保 Python 进程有权限读取；第三在 Python 终端观察是否打印"推演已暂停"的日志消息；最后检查控制文件格式是否完整（包含 paused、speed_multiplier、blue_task_mode、timestamp 四个字段）。

**问题**：调整倍速后推演速度未改变。  
**原因**：控制文件中 `speed_multiplier` 字段未正确更新或Python引擎未响应。  
**解决方案**：打开 `simulation_control.json` 文件查看 `speed_multiplier` 值是否与界面选择一致（0.5、1.0、2.0、5.0、10.0）；确认 Python 终端是否打印"推演倍速已调整"的日志；若仍无效，尝试暂停后再恢复，触发控制文件重新读取。

### 5.3 Tacview可视化相关问题

**问题**：Tacview无法连接到实时数据源。  
**原因**：Python服务器未启动、端口被占用或Tacview连接配置错误。  
**解决方案**：首先确认 Python 推演程序已成功启动并打印"Tacview服务器启动成功"消息；其次检查系统防火墙是否阻止端口 58008 的 TCP 连接；第三在 Tacview 中依次点击 File → Import Data from Real-Time Source，输入地址 `127.0.0.1:58008`，确保 IP 与端口无误；第四如端口被占用，可修改 `task_allocation.py` 中 `TacviewStreamer` 的 `local_port` 参数并重启推演。

**问题**：Tacview中飞机位置显示在错误的地理区域，与态势文件经纬度不符。  
**原因**：坐标转换参数设置错误或参考点配置不匹配。  
**解决方案**：检查 `task_allocation.py` 中的坐标系统配置常量（`REFERENCE_POINT_LAT`、`REFERENCE_POINT_LON`、`KM_PER_DEGREE_LAT`、`KM_PER_DEGREE_LON`）是否与态势文件的地理区域一致；确认态势文件中的经纬度在有效范围内（经度 -180 至 +180，纬度 -90 至 +90）；如需更改参考点，修改常量后重新运行推演。

**问题**：Tacview显示飞机数量少于预期，部分飞机未渲染。  
**原因**：大机群场景下数据包过大或帧同步机制失效。  
**解决方案**：首先查看 `tacview_data_log.txt` 日志文件，确认每帧是否包含所有飞机的数据行；其次检查终端输出的"Tacview发送"统计信息，观察发送字节数与飞机数量是否匹配；第三确认使用的 Tacview 版本支持 ACMI 2.1 格式；最后如问题持续，尝试减少飞机数量至 50 架以下验证基本功能。

### 5.4 文件操作相关问题

**问题**：加载JSON文件时提示"无法解析JSON文件"或"JSON格式错误"。  
**原因**：文件格式不符合JSON规范、存在非法字符或编码不正确。  
**解决方案**：使用文本编辑器（如 VSCode、Notepad++）打开 JSON 文件，检查是否存在语法错误（如缺少逗号、引号不匹配、尾部多余逗号等）；确认文件编码为 UTF-8（可通过编辑器的"另存为"功能转换）；使用在线 JSON 校验工具（如 jsonlint.com）验证文件格式；如文件来源于第三方系统，确认字段名称与数据类型与系统期望的格式一致。

**问题**：保存XML文件后无法重新加载，提示"无法解析XML文件"。  
**原因**：XML节点嵌套错误或标签未正确闭合。  
**解决方案**：使用支持 XML 语法高亮的编辑器打开文件，检查 `<situation>`、`<red_aircraft>`、`<blue_aircraft>`、`<aircraft>`、`<parameters>` 等标签是否成对出现；确认每个字段标签（如 `<id>`、`<longitude>` 等）内容不为空且数据类型正确；验证 XML 声明头 `<?xml version="1.0" encoding="UTF-8"?>` 存在且位于文件首行。

### 5.5 性能与稳定性相关问题

**问题**：推演速度明显慢于预期，即使使用高倍速仍卡顿。  
**原因**：飞机数量过多、系统资源不足或Python脚本陷入死循环。  
**解决方案**：首先查看任务管理器中 Python 进程的 CPU 占用率，若持续 100% 可能存在性能瓶颈；其次检查态势文件中的飞机总数（红方+蓝方），建议单次推演不超过 100 架；第三尝试关闭 Tacview 可视化与态势广播，仅运行任务分配与推演核心逻辑；第四如使用虚拟机或低性能设备，降低推演步数或减少飞机数量。

**问题**：任务分配耗时过长，超过1分钟仍未完成。  
**原因**：飞机数量超出快速评分算法的优化范围或代码版本较旧。  
**解决方案**：首先确认 `task_allocation.py` 中的 `compute_all_shapley_values` 方法调用的是 `calculate_fast_score` 而非被注释的 `calculate_shapley_value`；其次检查飞机总数是否超过 200 架，如超出可考虑分批推演或提高硬件配置；第三查看终端输出的"快速评分计算"日志，确认性能提升百分比符合预期；最后如问题持续，在日志中记录计算耗时并联系技术支持。

### 5.6 在线调试相关问题

**问题**：`online_debug.py` 启动后无法连接远端服务器。  
**原因**：网络配置错误、远端地址不可达或防火墙阻止连接。  
**解决方案**：首先使用 `ping` 命令测试远端 IP 地址（默认 180.1.80.3）的连通性；其次检查脚本中的 `REMOTE_IP` 与 `REMOTE_PORT` 配置是否与实际试验平台一致；第三确认本地防火墙允许 UDP 出站连接；第四如无远端平台，启动 `mock_remote_server.py` 进行本地闭环测试；最后检查网络代理设置，确保 UDP 流量未被拦截。

**问题**：模拟服务器接收到节点注册消息但未自动发送"试验开始"指令。  
**原因**：脚本逻辑未正确触发或客户端地址记录失败。  
**解决方案**：在 `mock_remote_server.py` 的 `start` 方法中添加调试输出，确认 `self.client_address` 变量已正确赋值；检查脚本中的 `send_control_message` 方法是否正常执行并打印"已发送管控消息"日志；如未触发，手动调用该方法并指定目标地址；验证调试端是否打印"接收到试验管控消息"的日志。

## 6. 附录

### 6.1 快捷键
界面支持常用快捷键操作，包括打开、保存、切换日志面板与帮助提示等功能，便于高频操作场景快速完成数据加载与持久化。

### 6.2 文件说明
界面核心逻辑位于 `mainwindow.cpp/h`，数据模型为 `aircraftmodel.cpp/h`，蓝方生成算法位于 `situationgenerator.cpp/h`。Python 任务分配与仿真在 `task_allocation.py`，Tacview 实时流封装与日志在同文件中的 `TacviewStreamer`，在线联调与协议解析位于 `online_debug.py`，HTTP 端口测试在 `http_connect.py`。控制与示例数据分别为 `simulation_control.json` 与 `situation.json`，临时批处理脚本 `run_simulation_temp.bat` 用于在终端中激活环境后直接运行推演脚本。

### 6.3 版本历史
当前版本已实现红蓝态势管理、智能蓝方生成、快速评分任务分配、实时仿真与 Tacview 集成，并补齐大机群条件下的帧同步发送修复与日志溯源能力，为后续扩展更复杂的行为模型与多域协同奠定基础。

### 6.4 关键配置参数速查表

**坐标系统参数**（`task_allocation.py`）：
- 参考点纬度：`REFERENCE_POINT_LAT = 39.53`（度）
- 参考点经度：`REFERENCE_POINT_LON = 115.7`（度）
- 纬度转换系数：`KM_PER_DEGREE_LAT = 111.0`（千米/度）
- 经度转换系数：`KM_PER_DEGREE_LON ≈ 85.5`（千米/度，北纬39.53°）

**飞行动力学参数**（`DroneSimulation` 类）：
- 最大速度：`max_speed = 15.0`（千米每小时）
- 最大加速度：`max_acceleration = 8.0`（米每秒平方）
- 最大角速度：`max_angular_velocity = 45.0`（度每秒）
- 平滑因子：`smoothing_factor = 0.15`（0-1，越小越平滑）
- 目标导向权重：70%，编队导向权重：30%

**仿真控制参数**：
- 时间步长：`dt = 0.1`（秒）
- 默认总步数：`steps = 1000`（对应100秒）
- 控制文件检查间隔：`0.5`（秒）
- 倍速选项：0.5x、1x、2x、5x、10x

**网络通信参数**：
- Tacview服务器：`127.0.0.1:58008`（TCP）
- 态势广播：`127.0.0.1:10114`（UDP JSON）
- 在线调试本地端口：`127.0.0.1:10113`（UDP）
- Tacview发送缓冲区：`512KB`

**任务分配参数**（`GameBasedTaskAllocation` 类）：
- 机动性权重：35%，动力权重：35%，距离权重：30%
- 攻击模式距离容忍半径：30 千米
- 防御模式距离敏感半径：15 千米
- 重平衡最大转移次数：20 次
- 平衡比阈值：0.6

### 6.5 文件清单与职责说明

**C++ 界面源文件**：
- `mainwindow.cpp/h`：主窗口实现，包含界面布局、事件响应、控制逻辑与统计计算
- `aircraftmodel.cpp/h`：飞机数据模型，实现表格视图的数据接口与输入校验
- `aircraft.h`：飞机数据结构定义与 JSON 序列化/反序列化方法
- `situationgenerator.cpp/h`：蓝方态势生成算法，基于红方数据生成对抗态势
- `mainwindow.ui`：Qt Designer 界面布局文件（XML 格式）
- `jiemian1.pro`：Qt 项目配置文件，定义编译选项与依赖关系

**Python 推演引擎**：
- `task_allocation.py`：任务分配与推演主程序，包含快速评分、博弈论分配、飞行动力学仿真与 Tacview 流输出
- `tacview.py`：Tacview 协议参考实现（独立示例）
- `fourty_enemy.py`：40 架敌机场景测试脚本（性能验证用）

**在线调试脚本**：
- `online_debug.py`：UDP 协议适配器，实现与远端试验平台的双向通信与消息格式转换
- `http_connect.py`：HTTP 链路测试工具，发送 JSON 状态消息到远端 HTTP 端点
- `mock_remote_server.py`：本地模拟服务器，接收 UDP 消息并发送管控指令用于闭环测试

**数据与配置文件**：
- `simulation_control.json`：推演控制文件，包含暂停标志、倍速因子与任务模式
- `situation.json`：态势数据文件（示例），包含红蓝双方飞机与生成参数
- `situation3.json / situation9.json / situation10.json / situation100.json`：不同规模的测试态势
- `test_control.json`：测试用控制文件模板
- `task_allocation_output.json`：任务分配结果输出文件
- `tacview_data_log.txt`：Tacview 数据流日志文件（运行时生成）

**辅助脚本**：
- `run_simulation_temp.bat`：Windows 批处理脚本，激活 Conda 环境并启动推演程序

**文档文件**：
- `README.md`：项目简介与开发待办事项
- `TACVIEW_FIX_README.md`：Tacview 大机群数据发送修复说明
- `试验执行软件-功能报告.md`：原始功能报告模板
- `试验执行软件-功能报告-自动生成.md`：本报告文件

**用户手册**（Word 文档）：
- `【非密】[非密]试验准备软件-用户手册.docx`
- `【非密】[非密]试验执行软件-用户手册.docx`
- `【非密】[非密]试验筹划软件-用户手册.docx`

### 6.6 版本历史与后续规划

**当前版本 v1.0**（2025年11月）：
- 实现红蓝态势管理与表格化编辑，支持 JSON/XML 双格式
- 实现智能蓝方生成算法，提供自动推荐与手动覆盖机制
- 实现基于快速评分的任务分配算法，性能提升 10-100 倍
- 实现基于飞行动力学的实时推演仿真，支持编队协同
- 集成 Tacview 实时数据流输出，修复大机群帧同步问题
- 实现跨进程实时控制（暂停/倍速/模式切换）
- 实现在线调试模块与本地模拟服务器
- 建立完整的日志系统与性能监控机制

**后续规划 v2.0**：
- 引入强化学习智能决策模型，提升编队协同策略
- 扩展多域作战能力，支持海空天地电多维态势
- 实现分布式计算框架，支持千架级别超大规模推演
- 增加威胁评估与战损计算模块，模拟攻防交互
- 开发态势回放与对比分析工具，支持多次推演结果对比
- 优化界面交互，增加三维可视化预览与态势编辑器
- 完善协议适配层，支持更多试验平台互联标准
- 建立自动化测试框架，提升系统稳定性与可维护性

### 6.7 技术支持与反馈

如需获取技术支持、反馈改进建议或报告系统缺陷，请通过以下方式联系：

1. **日志收集**：优先提供界面日志面板截图、Python 终端完整输出、`tacview_data_log.txt` 文件以及 `simulation_control.json` 内容
2. **问题描述**：详细说明操作步骤、预期结果与实际结果，包括飞机数量、文件格式、任务模式等关键参数
3. **环境信息**：提供操作系统版本、Qt 版本、Python 版本、Conda 环境配置以及 Tacview 版本
4. **复现步骤**：如问题可稳定复现，提供最小化的复现步骤与态势数据文件

建议在提交问题前查阅本报告第 5 章"常见问题与解决方案"，多数问题可通过配置调整或参数修正自行解决。对于涉及算法改进、功能扩展或架构优化的建议，请附上详细的需求描述与应用场景说明，以便评估优先级与实施可行性。

---

**报告编制说明**：本报告基于系统源代码与配置文件自动生成，内容真实反映了当前版本的功能实现与技术规格。报告采用自然段落体例，兼顾技术深度与可读性，适合系统开发人员、试验执行人员以及技术管理人员阅读。如发现报告内容与实际代码存在差异，请以源代码为准并及时反馈以更新文档。

**文档维护**：随系统版本迭代，本报告应同步更新功能描述、技术规格与操作流程。建议在每次重大版本发布时重新生成报告并归档历史版本，确保文档与代码的一致性与可追溯性。



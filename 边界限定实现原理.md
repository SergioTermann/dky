# 输入验证实现原理说明

## 修改的文件和函数

**文件**：`aircraftmodel.cpp`  
**函数**：`AircraftModel::setData(const QModelIndex &index, const QVariant &value, int role)`

## 工作原理

### 1. Qt MVC 模型的数据流

```
用户在表格中编辑单元格
    ↓
Qt框架捕获编辑事件
    ↓
调用 AircraftModel::setData() 函数
    ↓
验证输入数据
    ↓
验证通过 → 保存数据并更新视图
验证失败 → 返回false，数据不保存，显示错误提示
```

### 2. `setData` 函数的作用

`setData` 是 `QAbstractTableModel` 的虚函数，当用户在表格中编辑单元格时，Qt框架会自动调用这个函数。

**函数签名**：
```cpp
bool AircraftModel::setData(const QModelIndex &index, const QVariant &value, int role)
```

**参数说明**：
- `index`：被编辑的单元格索引（包含行、列信息）
- `value`：用户输入的新值（QVariant类型，可以包含各种数据类型）
- `role`：数据角色（通常为 `Qt::EditRole`，表示编辑角色）

**返回值**：
- `true`：数据保存成功，视图会更新显示新值
- `false`：数据保存失败，视图会恢复原来的值

### 3. 验证机制的三层防护

#### 第一层：空值检查
```cpp
if (strValue.isEmpty()) {
    QMessageBox::warning(nullptr, "输入错误", "字段不能为空！");
    return false;  // 阻止保存
}
```

#### 第二层：格式验证（正则表达式）

**对于不允许负数的字段（高度、速度、航向）**：
```cpp
QRegExp regex("^\\d+(\\.\\d+)?$");  // 只允许数字和小数点，不允许负号
```

**对于允许负数的字段（经度、纬度）**：
```cpp
QRegExp regex("^-?\\d+(\\.\\d+)?$");  // 允许负号、数字和小数点
```

**正则表达式解释**：
- `^`：字符串开始
- `\\d+`：一个或多个数字（0-9）
- `(\\.\\d+)?`：可选的小数部分（小数点 + 数字）
- `$`：字符串结束
- `-?`：可选的负号（仅用于经度、纬度）

**示例匹配**：
- `"123"` ✓ 匹配
- `"123.45"` ✓ 匹配
- `"-123"` ✓ 匹配（仅经度、纬度）
- `"-123"` ✗ 不匹配（高度、速度、航向）
- `"abc"` ✗ 不匹配
- `"123abc"` ✗ 不匹配

#### 第三层：范围验证
```cpp
// 航向范围：0 到 360
if (heading < 0.0 || heading > 360.0) {
    QMessageBox::warning(nullptr, "范围错误", "航向超出有效范围！");
    return false;  // 阻止保存
}
```

### 4. 禁止负数的实现原理

**正则表达式差异**：

**允许负数（经度、纬度）**：
```cpp
QRegExp regex("^-?\\d+(\\.\\d+)?$");
//           ^^
//           这个 -? 表示可选的负号
```

**禁止负数（高度、速度、航向）**：
```cpp
QRegExp regex("^\\d+(\\.\\d+)?$");
//           ^
//           没有 -?，所以不允许负号
```

**工作流程**：
1. 用户输入 `-100`
2. 对于经度/纬度：正则表达式 `"^-?\\d+(\\.\\d+)?$"` 匹配 `"-100"` ✓（允许）
3. 对于高度/速度/航向：正则表达式 `"^\\d+(\\.\\d+)?$"` 不匹配 `"-100"` ✗（禁止）
4. 如果匹配失败，显示错误提示并返回 `false`

### 5. 数据保存流程

**验证通过后**：
```cpp
aircraft.longitude = longitude;  // 保存数据到模型
emit dataChanged(index, index);  // 通知视图更新显示
return true;  // 告诉Qt数据保存成功
```

**验证失败时**：
```cpp
QMessageBox::warning(nullptr, "输入错误", "错误信息");
return false;  // 告诉Qt数据保存失败，视图会恢复原值
```

## 各字段的验证规则

| 字段 | 允许负数 | 范围限制 | 正则表达式 |
|------|---------|---------|-----------|
| 经度 (LONGITUDE) | ✓ | -180 到 180 | `^-?\\d+(\\.\\d+)?$` |
| 纬度 (LATITUDE) | ✓ | -90 到 90 | `^-?\\d+(\\.\\d+)?$` |
| 高度 (ALTITUDE) | ✗ | 无限制 | `^\\d+(\\.\\d+)?$` |
| 速度 (SPEED) | ✗ | 无限制 | `^\\d+(\\.\\d+)?$` |
| 航向 (HEADING) | ✗ | 0 到 360 | `^\\d+(\\.\\d+)?$` |

## 错误提示机制

当验证失败时，使用 `QMessageBox::warning()` 显示错误对话框：

```cpp
QMessageBox::warning(nullptr, "输入错误", 
    QString("经度只能输入数字！\n您输入的值：%1\n请输入有效的经度值（-180 到 180）")
    .arg(strValue));
```

**错误提示类型**：
1. **输入错误**：输入包含字母或无效字符
2. **范围错误**：数值超出有效范围
3. **格式错误**：无法转换为数字

## 完整验证流程示例（航向字段）

```cpp
case HEADING: {
    // 1. 获取输入值并去除空格
    QString strValue = value.toString().trimmed();
    
    // 2. 第一层：空值检查
    if (strValue.isEmpty()) {
        QMessageBox::warning(nullptr, "输入错误", "航向不能为空！");
        return false;
    }
    
    // 3. 第二层：格式验证（正则表达式）
    QRegExp regex("^\\d+(\\.\\d+)?$");  // 不允许负号
    if (!regex.exactMatch(strValue)) {
        QMessageBox::warning(nullptr, "输入错误", "航向只能输入数字！");
        return false;
    }
    
    // 4. 转换为数值
    bool ok;
    double heading = strValue.toDouble(&ok);
    if (!ok) {
        QMessageBox::warning(nullptr, "输入错误", "航向格式错误！");
        return false;
    }
    
    // 5. 第三层：范围验证
    if (heading < 0.0 || heading > 360.0) {
        QMessageBox::warning(nullptr, "范围错误", "航向超出有效范围！");
        return false;
    }
    
    // 6. 验证通过，保存数据
    aircraft.heading = heading;
    emit dataChanged(index, index);
    return true;
}
```

## 总结

### 核心要点

1. **修改位置**：`aircraftmodel.cpp` 的 `AircraftModel::setData()` 函数
2. **触发时机**：用户在表格中编辑单元格时，Qt框架自动调用
3. **验证方式**：三层验证（空值检查 → 正则表达式格式验证 → 数值范围验证）
4. **禁止负数**：通过正则表达式去掉 `-?`（可选负号）实现
5. **错误处理**：验证失败时返回 `false`，显示错误提示，数据不保存


